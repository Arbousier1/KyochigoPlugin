<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Economy Core | 经济系统管理台</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        [v-cloak] { display: none !important; }
        body { 
            font-family: 'Inter', system-ui, -apple-system, sans-serif; 
            background-color: #f8fafc; /* Slate-50 */
            color: #334155; /* Slate-700 */
        }

        /* --- 动态背景动画 --- */
        .ambient-bg { position: fixed; inset: 0; z-index: 0; pointer-events: none; }
        .ambient-blob { position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.6; animation: float 20s infinite ease-in-out alternate; }
        .blob-1 { top: -10%; left: -10%; width: 50vw; height: 50vw; background: #e0e7ff; }
        .blob-2 { bottom: -10%; right: -10%; width: 60vw; height: 60vw; background: #f0fdf4; animation-delay: -5s; }

        @keyframes float {
            0% { transform: translate(0, 0) scale(1); }
            100% { transform: translate(30px, 50px) scale(1.1); }
        }

        .bg-grid {
            position: fixed; inset: 0; z-index: 1; pointer-events: none;
            background-size: 40px 40px;
            background-image: linear-gradient(to right, rgba(0, 0, 0, 0.03) 1px, transparent 1px),
                              linear-gradient(to bottom, rgba(0, 0, 0, 0.03) 1px, transparent 1px);
        }

        /* --- 玻璃拟态卡片 --- */
        .glass-card {
            background: rgba(255, 255, 255, 0.85); 
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6); 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }

        .input-modern {
            width: 100%; outline: none; border-radius: 0.5rem; padding: 0.6rem 0.8rem; font-size: 0.875rem;
            background-color: #ffffff; border: 1px solid #cbd5e1; color: #0f172a; transition: all 0.2s;
        }
        .input-modern:focus { border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15); }

        /* --- Tooltip 系统 --- */
        .info-trigger { 
            cursor: help; 
            border-bottom: 1px dashed #cbd5e1; 
            display: inline-flex; 
            align-items: center; 
            gap: 4px; 
            position: relative; 
            transition: border-color 0.2s;
        }
        .info-trigger:hover { border-bottom-color: #6366f1; }
        
        .tooltip-box {
            visibility: hidden; 
            position: absolute; 
            z-index: 100; 
            width: 260px;
            background: rgba(255, 255, 255, 0.98);
            border: 1px solid #e2e8f0;
            color: #475569; /* Slate-600 */
            padding: 12px; 
            border-radius: 8px;
            font-size: 12px; 
            line-height: 1.6;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            opacity: 0; 
            transition: all 0.2s ease; 
            bottom: 130%; 
            left: 50%; 
            transform: translateX(-50%) translateY(5px); 
            pointer-events: none;
            font-weight: normal;
            text-transform: none;
            text-align: left;
        }

        /* 修复靠左显示的 Tooltip */
        .tooltip-box.tooltip-left {
            left: 0;
            transform: translateY(5px); 
        }
        .tooltip-box.tooltip-left::after {
            left: 20px; 
        }
        
        /* 修复靠右显示的 Tooltip */
        .tooltip-box.tooltip-right {
            left: auto;
            right: 0;
            transform: translateY(5px);
        }
        .tooltip-box.tooltip-right::after {
            left: auto;
            right: 20px;
        }

        /* 小三角 */
        .tooltip-box::after {
            content: ''; position: absolute; top: 100%; left: 50%; margin-left: -6px;
            border-width: 6px; border-style: solid; 
            border-color: #ffffff transparent transparent transparent;
            filter: drop-shadow(0 1px 0 #e2e8f0);
        }

        .info-trigger:hover .tooltip-box { 
            visibility: visible; 
            opacity: 1; 
            transform: translateX(-50%) translateY(0); 
        }
        .info-trigger:hover .tooltip-box.tooltip-left { transform: translateY(0); }
        .info-trigger:hover .tooltip-box.tooltip-right { transform: translateY(0); }

        .tooltip-box b { color: #6366f1; display: block; margin-bottom: 4px; font-size: 13px; font-weight: 700; }
        .tooltip-box span.formula { font-family: 'Courier New', monospace; background: #f1f5f9; padding: 2px 4px; border-radius: 3px; color: #334155; border: 1px solid #e2e8f0;}

        .sidebar-item.active { background: linear-gradient(90deg, rgba(99, 102, 241, 0.08), transparent); border-left: 3px solid #6366f1; }
        .neff-bar { height: 3px; background: #e2e8f0; border-radius: 2px; overflow: hidden; margin-top: 8px; }
        .neff-fill { height: 100%; background: #6366f1; transition: width 0.5s ease; }
    </style>
</head>
<body>

    <div class="ambient-bg">
        <div class="ambient-blob blob-1"></div>
        <div class="ambient-blob blob-2"></div>
    </div>
    <div class="bg-grid"></div>

    <div id="app" class="relative z-10 flex w-full h-screen overflow-hidden" v-cloak>
        
        <aside class="w-80 bg-white/80 backdrop-blur-xl border-r border-slate-200 flex flex-col z-20">
            <div class="p-6 border-b border-slate-100">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center shadow-lg text-white">
                        <i data-lucide="layout-grid" class="w-5 h-5"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-slate-800 text-lg">Economy Core</h1>
                        <div class="flex items-center gap-2">
                            <div class="w-2 h-2 rounded-full" :class="serverStatus ? 'bg-emerald-500' : 'bg-red-500'"></div>
                            <span class="text-[10px] font-bold uppercase text-slate-500">{{ serverStatus ? 'Online' : 'Offline' }}</span>
                        </div>
                    </div>
                </div>
                <div class="relative">
                    <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-slate-400"></i>
                    <input v-model="searchQuery" placeholder="检索商品..." class="input-modern pl-10 h-10">
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-3 space-y-1">
                <div v-for="item in filteredItems" :key="item.id" @click="selectItem(item)"
                     class="sidebar-item p-3 rounded-lg cursor-pointer transition-all hover:bg-slate-50"
                     :class="{'active': activeItem.id === item.id}">
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-bold text-sm text-slate-700">{{ item.name }}</span>
                        <span class="text-[10px] font-mono text-slate-400 uppercase">{{ item.id.split(':')[1] || item.id }}</span>
                    </div>
                    <div class="flex justify-between text-[10px] text-slate-500">
                        <div class="info-trigger" style="border:none">
                            <span>Neff: {{ Math.round(item.n) }}</span>
                        </div>
                        <div class="info-trigger" style="border:none">
                            <span class="text-amber-600 font-bold">P₀: {{ item.basePrice }}</span>
                        </div>
                    </div>
                    <div class="neff-bar">
                        <div class="neff-fill" :style="{ width: Math.min(100, (item.n / 1000) * 100) + '%', backgroundColor: getNeffColor(item.n) }"></div>
                    </div>
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col relative">
            <header class="h-16 border-b border-slate-200 bg-white/60 backdrop-blur-md flex justify-between items-center px-8 z-10">
                <div class="flex gap-1 p-1 bg-slate-100 rounded-lg">
                    <button @click="currentTab = 'simulation'" 
                            class="px-4 py-1.5 rounded-md text-sm font-medium transition-all" 
                            :class="currentTab === 'simulation' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'">
                        动态建模
                    </button>
                    <button @click="currentTab = 'config'" 
                            class="px-4 py-1.5 rounded-md text-sm font-medium transition-all" 
                            :class="currentTab === 'config' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'">
                        全局策略
                    </button>
                </div>
                
                <div class="flex items-center gap-6">
                    <div class="text-right">
                        <div class="info-trigger text-[10px] font-bold text-slate-400 uppercase tracking-widest">
                            实时环境因子 ε
                            <div class="tooltip-box tooltip-right">
                                <b>Environment Factor (ε)</b>
                                包含节假日、周末及随机波动的实时指数。
                                <br>• ε > 1.0: 通货膨胀（物价普涨）
                                <br>• ε < 1.0: 通货紧缩（物价普跌）
                            </div>
                        </div>
                        <span class="text-xl font-mono font-bold text-slate-800 block">{{ currentEnv.toFixed(4) }}</span>
                        <span class="text-[10px] text-indigo-500 font-mono h-4 block">{{ envNote }}</span>
                    </div>
                </div>
            </header>

            <div class="flex-1 relative p-6 overflow-hidden">
                <div v-show="currentTab === 'simulation'" class="absolute inset-0 p-6 flex gap-6">
                    <div class="w-80 flex flex-col gap-6">
                        <div class="glass-card rounded-2xl p-6">
                            <h3 class="text-[10px] font-bold text-slate-400 uppercase mb-4 tracking-widest flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-indigo-500"></span> 市场快照
                            </h3>
                            <div v-if="activeItem.id" class="space-y-4">
                                <div>
                                    <div class="text-2xl font-black text-slate-800 leading-tight">{{ activeItem.name }}</div>
                                    <div class="text-xs text-slate-400 mt-1 font-mono">{{ activeItem.id }}</div>
                                </div>
                                <div class="grid grid-cols-1 gap-3">
                                    <div class="bg-indigo-50 p-3 rounded-xl border border-indigo-100">
                                        <div class="info-trigger text-[10px] text-indigo-400 font-bold uppercase mb-1 flex justify-between">
                                            <span>当前回收价</span>
                                            <span class="text-[8px] opacity-70">Sell</span>
                                            <div class="tooltip-box tooltip-left">
                                                <b>最终售价 (Final Price)</b>
                                                后端根据历史衰减计算的实际价格。<br>
                                                <span class="formula">P = ε · P₀ · e^(-λ · N)</span>
                                            </div>
                                        </div>
                                        <div class="text-lg font-mono font-bold text-indigo-600">{{ currentPrice.toFixed(2) }}</div>
                                    </div>
                                    <div class="bg-white p-3 rounded-xl border border-slate-200 flex justify-between items-center">
                                        <div>
                                            <div class="info-trigger text-[10px] text-slate-400 font-bold uppercase mb-1">
                                                当前买入价
                                                <div class="tooltip-box tooltip-left">
                                                    <b>买入价</b>
                                                    商店出售给玩家的价格。<br>
                                                    <span class="formula">Buy = Sell · Premium</span>
                                                </div>
                                            </div>
                                            <div class="text-md font-mono font-bold text-slate-700">{{ buyPrice.toFixed(2) }}</div>
                                        </div>
                                        <div class="text-[10px] text-slate-400 font-bold">x{{ config?.buyPremium }}</div>
                                    </div>
                                    <div class="bg-slate-50 p-3 rounded-xl border border-slate-100">
                                        <div class="info-trigger text-[10px] text-slate-400 font-bold uppercase mb-1">
                                            实时库存
                                            <div class="tooltip-box tooltip-left">
                                                <b>Live Neff</b>
                                                后端聚合了全服历史记录衰减后的当前库存量。
                                            </div>
                                        </div>
                                        <div class="text-lg font-mono font-bold text-slate-700">{{ simN.toFixed(2) }}</div>
                                    </div>
                                </div>
                            </div>
                            <div v-else class="py-12 flex flex-col items-center justify-center text-slate-400 text-xs italic border-2 border-dashed border-slate-200 rounded-xl">
                                <i data-lucide="mouse-pointer-2" class="w-6 h-6 mb-2 opacity-50"></i>
                                选择商品加载模型
                            </div>
                        </div>

                        <div class="glass-card rounded-2xl p-6 flex-1 flex flex-col">
                            <h3 class="text-[10px] font-bold text-slate-400 uppercase mb-6 tracking-widest flex items-center gap-2">
                                <i data-lucide="activity" class="w-3 h-3"></i> 压力测试
                            </h3>
                            <div class="space-y-5">
                                <div>
                                    <label class="info-trigger text-[10px] font-bold text-slate-500 uppercase">
                                        交易规模 (Δn)
                                        <div class="tooltip-box tooltip-left">
                                            <b>Delta N</b>
                                            单次交易模拟的数量。用于测试大额抛售或买入对价格造成的冲击（滑点）。
                                        </div>
                                    </label>
                                    <div class="flex gap-2 mt-1">
                                        <input type="number" v-model.number="tradeAmount" class="input-modern font-mono font-bold">
                                        <button @click="tradeAmount=64" class="px-3 text-xs bg-slate-100 text-slate-500 rounded-md hover:bg-slate-200">64</button>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <button @click="simulateTrade('buy')" :disabled="!activeItem.id" class="py-3 bg-slate-800 text-white rounded-xl text-xs font-bold shadow-lg hover:bg-slate-700 disabled:opacity-50 transition-all">模拟买入</button>
                                    <button @click="simulateTrade('sell')" :disabled="!activeItem.id" class="py-3 bg-white text-slate-800 border border-slate-200 rounded-xl text-xs font-bold hover:bg-slate-50 disabled:opacity-50 transition-all">模拟卖出</button>
                                </div>
                                <div v-if="simResult" class="mt-auto pt-4 border-t border-slate-100">
                                    <div class="flex justify-between items-end">
                                        <span class="text-[10px] text-slate-400">预估总额</span>
                                        <span class="text-xl font-mono font-bold" :class="simResult.type === 'buy' ? 'text-red-500' : 'text-emerald-500'">{{ simResult.totalPrice.toFixed(2) }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex-1 glass-card rounded-2xl p-6 flex flex-col">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest flex items-center gap-2">
                                <i data-lucide="line-chart" class="w-3 h-3"></i> 价格曲线模型
                            </h3>
                            <div v-if="activeItem.id" class="info-trigger text-[10px] px-2 py-1 bg-indigo-50 text-indigo-600 rounded font-mono">
                                λ = {{ activeItem.lambda }}
                                <div class="tooltip-box tooltip-right">
                                    <b>Decay Lambda (价格敏感度)</b>
                                    控制价格随库存增加而下跌的速率。
                                    <br>• λ 越大：价格对库存变化越敏感（跌得快）。
                                    <br>• λ 越小：价格越稳定（稀有物品）。
                                </div>
                            </div>
                        </div>
                        <div id="priceChart" class="flex-1 w-full h-full"></div>
                    </div>
                </div>

                <div v-show="currentTab === 'config'" class="absolute inset-0 p-8 overflow-y-auto">
                    <div class="max-w-4xl mx-auto space-y-10 pb-20">
                        <div class="flex justify-between items-center">
                            <div>
                                <h2 class="text-3xl font-black text-slate-800 tracking-tight">全局策略</h2>
                                <p class="text-slate-500 text-sm mt-2">鼠标悬停在参数名上可查看数学定义</p>
                            </div>
                            <button @click="saveConfig" class="px-6 py-2 bg-indigo-600 text-white rounded-xl font-bold shadow-lg hover:bg-indigo-500 transition-all flex items-center gap-2">
                                <i data-lucide="save" class="w-4 h-4"></i> 保存配置
                            </button>
                        </div>
                        
                        <div v-if="config" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="glass-card p-6 rounded-2xl space-y-4">
                                <h4 class="text-xs font-bold text-indigo-600 uppercase tracking-widest flex items-center gap-2">
                                    <i data-lucide="refresh-cw" class="w-4 h-4"></i> 自动修复逻辑
                                </h4>
                                <div>
                                    <div class="info-trigger text-[10px] text-slate-400 font-bold block mb-1">
                                        修复强度系数 (δ)
                                        <div class="tooltip-box tooltip-left">
                                            <b>Recovery Delta</b>
                                            当市场无人交易时，价格自动回归基准价的速度。
                                            <br>数值越大，市场价格在波动后平复得越快。
                                        </div>
                                    </div>
                                    <input v-model.number="config.recoveryDelta" step="0.01" class="input-modern font-mono">
                                </div>
                                <div>
                                    <div class="info-trigger text-[10px] text-slate-400 font-bold block mb-1">
                                        时间周期常量 (τ)
                                        <div class="tooltip-box tooltip-left">
                                            <b>Time Constant (Tau)</b>
                                            定义“一个回复周期”的物理时间长度（秒）。
                                            <br>通常设置为 3600 (1小时)。
                                        </div>
                                    </div>
                                    <input v-model.number="config.recoveryTau" class="input-modern font-mono">
                                </div>
                            </div>
                            
                            <div class="glass-card p-6 rounded-2xl space-y-4">
                                <h4 class="text-xs font-bold text-amber-600 uppercase tracking-widest flex items-center gap-2">
                                    <i data-lucide="sliders" class="w-4 h-4"></i> 市场杠杆
                                </h4>
                                <div>
                                    <div class="info-trigger text-[10px] text-slate-400 font-bold block mb-1">
                                        买入溢价 (Spread)
                                        <div class="tooltip-box">
                                            <b>Spread Multiplier</b>
                                            控制买入价与卖出价的差额。
                                            <br>例如 1.25 表示：玩家买入价 = 玩家卖出价 * 1.25。
                                            <br>这是系统回收金币的主要手段。
                                        </div>
                                    </div>
                                    <input v-model.number="config.buyPremium" step="0.05" class="input-modern font-mono">
                                </div>
                                <div>
                                    <div class="info-trigger text-[10px] text-slate-400 font-bold block mb-1">
                                        基础环境指数 (ε)
                                        <div class="tooltip-box">
                                            <b>Base Epsilon</b>
                                            服务器默认的通胀系数。所有计算都会乘以这个基数。
                                        </div>
                                    </div>
                                    <input v-model.number="config.baseEnvIndex" step="0.1" class="input-modern font-mono">
                                </div>
                            </div>
                            
                            <div class="glass-card p-6 rounded-2xl md:col-span-2 space-y-4 bg-gradient-to-br from-white to-slate-50">
                                 <h4 class="text-xs font-bold text-slate-500 uppercase tracking-widest">全局库存偏移 (Iota)</h4>
                                 <div class="relative">
                                     <div class="info-trigger absolute right-0 top-[-20px] text-[10px] text-indigo-400 cursor-help">
                                         什么是 Iota?
                                         <div class="tooltip-box tooltip-right">
                                             <b>Global Inventory Offset (ι)</b>
                                             上帝之手参数。人为地向全服所有商品的库存计算公式中增加或减少一个虚拟数值。
                                             <br>• 正数：模拟物资过剩，全服降价。
                                             <br>• 负数：模拟物资紧缺，全服涨价。
                                         </div>
                                     </div>
                                     <input v-model.number="config.globalIota" type="number" class="input-modern font-black text-xl text-indigo-600">
                                 </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <div class="fixed top-6 right-6 z-50 flex flex-col gap-3 pointer-events-none">
            <transition-group name="toast">
                <div v-for="toast in toasts" :key="toast.id" class="pointer-events-auto bg-white text-slate-800 px-5 py-3.5 rounded-xl shadow-xl border border-slate-100 flex items-center gap-3">
                    <i data-lucide="check" class="w-4 h-4 text-emerald-500"></i>
                    <span class="text-xs font-bold">{{ toast.message }}</span>
                </div>
            </transition-group>
        </div>
    </div>

    <script>
        const { createApp, ref, reactive, onMounted, computed, watch, nextTick } = Vue;

        createApp({
            setup() {
                const serverStatus = ref(false);
                const currentTab = ref('simulation');
                const searchQuery = ref('');
                const playerId = ref('System_Manager');
                const config = ref(null);
                const items = ref([]);
                const activeItem = reactive({ id: '', name: '', basePrice: 0, n: 0, lambda: 0 });
                const simN = ref(0);
                const currentEnv = ref(1.0);
                const envNote = ref('Normal');
                const currentPrice = ref(0);
                const buyPrice = ref(0);
                const tradeAmount = ref(64);
                const simResult = ref(null);
                const toasts = ref([]);
                let myChart = null;

                // 监听 Tab 切换，防止在 display:none 时渲染图表
                watch(currentTab, (newTab) => {
                    if (newTab === 'simulation' && activeItem.id) {
                        nextTick(() => {
                            if (!myChart) {
                                myChart = echarts.init(document.getElementById('priceChart'));
                            }
                            myChart.resize();
                            renderChart();
                        });
                    }
                });

                const filteredItems = computed(() => {
                    const q = searchQuery.value.toLowerCase();
                    return items.value.filter(i => i.name.toLowerCase().includes(q) || i.id.toLowerCase().includes(q));
                });

                const getNeffColor = (n) => {
                    if (n > 2000) return '#ef4444';
                    if (n > 800) return '#f59e0b';
                    return '#6366f1';
                };

                const showToast = (message) => {
                    const id = Date.now();
                    toasts.value.push({ id, message });
                    setTimeout(() => toasts.value = toasts.value.filter(t => t.id !== id), 3000);
                };

                // 【核心更新】从后端获取实时数据（含衰减、节假日、噪声）
                const selectItem = async (item) => {
                    Object.assign(activeItem, item);
                    simResult.value = null;
                    
                    try {
                        // 调用后端行情接口获取真实数据
                        const res = await axios.post('/api/market/prices', { item_ids: [item.id] });
                        const data = res.data;
                        const liveItem = data.items[item.id];

                        if (liveItem) {
                            // 更新环境指数（包含节假日/噪声计算）
                            currentEnv.value = parseFloat(data.envIndex);
                            envNote.value = data.envNote;
                            
                            // 更新模拟库存（包含全服历史记录衰减）
                            simN.value = liveItem.neff;
                            
                            // 更新价格
                            currentPrice.value = liveItem.price;
                            buyPrice.value = liveItem.buy_price;
                        } else {
                            throw new Error("Item not found in response");
                        }
                    } catch (e) {
                        console.warn("Failed to fetch live data, using static config", e);
                        // 降级处理：使用静态配置
                        simN.value = item.n || 100;
                        currentEnv.value = config.value?.baseEnvIndex || 1.0;
                        envNote.value = "Unknown";
                        updatePrice();
                    }

                    nextTick(() => {
                       if (!myChart) myChart = echarts.init(document.getElementById('priceChart'));
                       renderChart(); 
                    });
                };

                const updatePrice = () => {
                    if (!activeItem.id) return;
                    const globalIota = config.value?.globalIota || 0;
                    // 注意：在模拟模式下，我们使用用户可调整的 simN，但环境指数保持为后端返回的实时值
                    currentPrice.value = currentEnv.value * activeItem.basePrice * Math.exp(-activeItem.lambda * (simN.value + globalIota));
                    buyPrice.value = currentPrice.value * (config.value?.buyPremium || 1.25);
                };

                watch(() => config.value?.globalIota, updatePrice);

                const simulateTrade = async (type) => {
                    if (!activeItem.id) return;
                    try {
                        const prevPrice = currentPrice.value;
                        const prevN = simN.value;
                        
                        const delta = type === 'buy' ? -tradeAmount.value : tradeAmount.value;
                        simN.value = Math.max(0, simN.value + delta);
                        
                        updatePrice();
                        
                        // 简单估算总额
                        const unitAvg = (prevPrice + currentPrice.value) / 2;
                        const totalPrice = unitAvg * tradeAmount.value;
                        
                        simResult.value = {
                            type: type,
                            totalPrice: totalPrice,
                            unitPriceAvg: unitAvg
                        };
                        
                        renderChart(type, prevN, tradeAmount.value);
                        showToast(`模拟执行成功: ${type.toUpperCase()}`);
                    } catch (e) { showToast("计算引擎未响应"); }
                };

                const renderChart = (action, startN, amount) => {
                    if (!myChart || !activeItem.id) return;
                    const globalIota = config.value?.globalIota || 0;
                    const maxN = Math.max(simN.value * 2, 2.0 / activeItem.lambda);
                    const step = maxN / 100;
                    const data = [];
                    for(let x=0; x<=maxN; x+=step) {
                        data.push([x, currentEnv.value * activeItem.basePrice * Math.exp(-activeItem.lambda * (x + globalIota))]);
                    }

                    const option = {
                        backgroundColor: 'transparent',
                        grid: { top: 30, right: 20, bottom: 30, left: 50 },
                        tooltip: { 
                            trigger: 'axis',
                            backgroundColor: '#ffffff',
                            borderColor: '#e2e8f0',
                            textStyle: { color: '#334155' }
                        },
                        xAxis: { 
                            type: 'value', name: 'N', 
                            nameTextStyle: { color: '#64748b' },
                            axisLabel: { color: '#64748b' },
                            splitLine: { lineStyle: { color: '#f1f5f9' } } 
                        },
                        yAxis: { 
                            type: 'value', name: 'Price',
                            nameTextStyle: { color: '#64748b' },
                            axisLabel: { color: '#64748b' },
                            splitLine: { lineStyle: { color: '#f1f5f9' } } 
                        },
                        series: [{
                            type: 'line', smooth: true, data, showSymbol: false,
                            lineStyle: { color: '#4f46e5', width: 3 },
                            areaStyle: { color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{offset: 0, color: 'rgba(99,102,241,0.2)'}, {offset: 1, color: 'rgba(99,102,241,0)'}]) }
                        }, {
                            type: 'effectScatter', data: [[simN.value, currentPrice.value]],
                            symbolSize: 14, itemStyle: { color: '#fbbf24', borderColor: '#000', borderWidth: 2 }
                        }]
                    };
                    
                    if(action) {
                        const x0 = action === 'buy' ? Math.max(0, startN - amount) : startN;
                        const x1 = action === 'buy' ? startN : startN + amount;
                        option.series[0].markArea = {
                            itemStyle: { color: action === 'buy' ? 'rgba(244,63,94,0.15)' : 'rgba(16,185,129,0.15)' },
                            data: [[{ xAxis: x0 }, { xAxis: x1 }]]
                        };
                    }
                    myChart.setOption(option, true);
                };

                const fetchMarket = async () => {
                    try {
                        const res = await axios.get('/api/market');
                        items.value = res.data;
                        serverStatus.value = true;
                    } catch { 
                        serverStatus.value = false; 
                        if(items.value.length === 0) {
                            items.value = [
                                {id: 'minecraft:stone', name: 'Stone', n: 500, basePrice: 1.0, lambda: 0.001},
                                {id: 'minecraft:diamond', name: 'Diamond', n: 20, basePrice: 100.0, lambda: 0.005}
                            ];
                        }
                    }
                };

                const fetchConfig = async () => {
                    try {
                        const res = await axios.get('/api/config');
                        config.value = res.data;
                    } catch(e) {
                         if(!config.value) config.value = { recoveryDelta: 0.05, recoveryTau: 3600, buyPremium: 1.25, baseEnvIndex: 1.0, globalIota: 0 };
                    }
                };

                const saveConfig = async () => {
                    try {
                        await axios.post('/api/config', config.value);
                        showToast("全局配置同步成功");
                    } catch { showToast("保存失败"); }
                };

                onMounted(() => {
                    lucide.createIcons();
                    fetchMarket();
                    fetchConfig();
                    setInterval(fetchConfig, 10000); 
                    window.addEventListener('resize', () => myChart && myChart.resize());
                });

                return {
                    serverStatus, currentTab, searchQuery, playerId, config, items, filteredItems,
                    activeItem, simN, currentEnv, envNote, currentPrice, buyPrice, tradeAmount, simResult, toasts,
                    selectItem, simulateTrade, saveConfig, fetchMarket, getNeffColor
                };
            }
        }).mount('#app');
    </script>
</body>
</html>